generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum GymTier {
  CORE
  SUPPORTING
  EDGE
}

enum InvoiceType {
  GST
  NON_GST
}

enum InvoiceTaxMode {
  CGST_SGST
  IGST
  NONE
}

enum InvoiceTaxType {
  CGST
  SGST
  IGST
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // hashed for credentials
  role          String    @default("USER") // USER | OWNER | ADMIN
  latitude      Float?
  longitude     Float?
  city          String?
  state         String?
  phoneNumber   String?
  billingEmail  String?
  billingAddress String?
  businessName   String?
  businessType   String?
  supportEmail   String?
  supportPhone   String?
  supportWhatsapp String?
  logoUrl        String?
  twoFactorEnabled Boolean @default(false)
  timezone      String?
  notifyMemberships Boolean @default(true)
  notifyPromos  Boolean  @default(true)
  notifyDuo     Boolean  @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]
  gymSessions GymSession[]
  weightLogs WeightLog[]
  memberships Membership[]
  duosAsOne    Duo[]       @relation("UserOne")
  duosAsTwo    Duo[]       @relation("UserTwo")
  invitesSent  Invite[]    @relation("Inviter")
  payments     Payment[]
  transactions Transaction[]
  ownedGyms    Gym[]
  savedGyms    SavedGym[]
  featuredPurchases FeaturedListingPurchase[]
  verifiedPurchases VerifiedBadgePurchase[]
  notifications Notification[]
  passwordResetTokens PasswordResetToken[]
  gymPageViews GymPageView[]
  emailVerificationTokens EmailVerificationToken[]
  ownerSubscriptions OwnerSubscription[]
  leads        Lead[]
  whatsappLogs WhatsAppLog[]
  ownerInvoices Invoice[] @relation("OwnerInvoices")
  memberInvoices Invoice[] @relation("MemberInvoices")
  subscriptionReminders SubscriptionReminderLog[]
}

model OwnerSubscription {
  id                 String   @id @default(cuid())
  ownerId            String
  plan               String   // STARTER | PRO
  status             String   // PENDING | ACTIVE | CANCELED | EXPIRED
  startsAt           DateTime
  expiresAt          DateTime
  razorpayOrderId    String?  @unique
  razorpayPaymentId  String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  reminders SubscriptionReminderLog[]

  @@index([ownerId])
  @@index([status])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  purpose   String   // VERIFY | DELETE
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Gym {
  id                     String   @id @default(cuid())
  name                   String
  address                String
  latitude               Float
  longitude              Float
  ownerId                String
  verificationStatus     String   @default("UNVERIFIED") // UNVERIFIED | PENDING | VERIFIED | REJECTED
  verificationNotes      String?
  gymTier                GymTier  @default(SUPPORTING)
  hasAC                  Boolean  @default(false)
  amenities              String[] @default([])
  ownerConsentAt         DateTime?
  city                   String?
  state                  String?
  suspendedAt            DateTime?
  lastContactedAt        DateTime?
  responsivenessScore    Int      @default(0)
  responsivenessOverride Int?
  gstNumber              String?
  gstCertificateUrl      String?
  gstVerifiedAt          DateTime?
  razorpaySubAccountId   String?
  bankAccountLast4       String?
  bankAccountVerified    Boolean  @default(false)
  openTime               String?  // "HH:mm"
  closeTime              String?  // "HH:mm"
  openDays               String?  // "MON,TUE,WED,THU,FRI,SAT,SUN"
  dayPassPrice           Int?     // in paise, optional
  monthlyPrice           Int      // in paise
  quarterlyPrice         Int?     // in paise, null = computed as monthlyPrice * 3
  yearlyPrice            Int      // in paise
  partnerDiscountPercent Int      @default(10)
  quarterlyDiscountType  String   @default("PERCENT") // PERCENT | FLAT
  quarterlyDiscountValue Int      @default(10)        // percent or paise (if FLAT)
  yearlyDiscountType     String   @default("PERCENT") // PERCENT | FLAT
  yearlyDiscountValue    Int      @default(15)        // percent or paise (if FLAT)
  welcomeDiscountType    String   @default("PERCENT") // PERCENT | FLAT
  welcomeDiscountValue   Int      @default(10)        // percent or paise (if FLAT)
  coverImageUrl          String?  // optional gym photo
  imageUrls              String[] @default([])
  instagramUrl           String?
  facebookUrl            String?
  youtubeUrl             String?
  isFeatured             Boolean  @default(false)
  featuredStartAt        DateTime?
  featuredEndAt          DateTime?
  featuredUntil          DateTime?
  verifiedUntil          DateTime?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  owner        User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  memberships  Membership[]
  duos         Duo[]
  invites      Invite[]
  payments     Payment[]
  discountCodes DiscountCode[]
  savedBy      SavedGym[]
  featuredPurchases FeaturedListingPurchase[]
  verifiedPurchases VerifiedBadgePurchase[]
  transactions Transaction[]
  pageViews   GymPageView[]
  leads       Lead[]
  whatsappLogs WhatsAppLog[]
  invoices    Invoice[]
  invoiceTypeDefault   InvoiceType?
  invoiceSequence InvoiceSequence?
  gymSessions GymSession[]
  qrStatics   QrStatic[]
  qrKeys      QrKey[]
  qrTokens    QrToken[]
  qrAuditLogs QrAuditLog[]
}

model GymSession {
  id                String   @id @default(uuid())
  userId            String
  gymId             String?
  entryAt           DateTime
  exitAt            DateTime?
  durationMinutes   Int?
  calories          Int?
  validForStreak    Boolean  @default(false)
  endedBy           String?
  verificationStatus String  @default("VERIFIED") // PENDING | VERIFIED | REJECTED
  deviceId          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  gym  Gym? @relation(fields: [gymId], references: [id], onDelete: SetNull)

  @@index([userId, entryAt])
  @@index([gymId, entryAt])
}

model WeightLog {
  id        String   @id @default(uuid())
  userId    String
  valueKg   Float
  loggedAt  DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, loggedAt])
}

model QrStatic {
  id               String   @id @default(uuid())
  gymId            String
  type             String   // ENTRY | EXIT | PAYMENT
  currentKeyVersion Int     @default(1)
  revokedAt        DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)
  keys QrKey[]

  @@unique([gymId, type])
  @@index([gymId])
}

model QrKey {
  id        String   @id @default(uuid())
  gymId     String
  type      String   // ENTRY | EXIT | PAYMENT
  version   Int
  active    Boolean  @default(true)
  rotatedAt DateTime?
  createdAt DateTime @default(now())

  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@unique([gymId, type, version])
  @@index([gymId, type, active])
}

model QrToken {
  id        String   @id @default(uuid())
  gymId     String
  type      String   // ENTRY | EXIT | PAYMENT
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  usedAt    DateTime?

  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@index([gymId, type, expiresAt])
}

model QrAuditLog {
  id        String   @id @default(uuid())
  actorId   String
  gymId     String
  type      String?
  action    String   // GENERATE | REGENERATE | REVOKE | BULK_GENERATE | BULK_EXPORT
  metadata  Json?
  createdAt DateTime @default(now())

  actor User @relation(fields: [actorId], references: [id], onDelete: Cascade)
  gym   Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@index([gymId, createdAt])
}

model QrBatchJob {
  id             String   @id @default(uuid())
  actorId        String
  scope          String   // ALL_GYMS | GYM
  gymId          String?
  status         String   // PENDING | RUNNING | COMPLETE | FAILED
  totalCount     Int      @default(0)
  processedCount Int      @default(0)
  downloadUrl    String?
  error          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  completedAt    DateTime?

  actor User @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@index([status, createdAt])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // membership_expiring | duo_accepted
  title     String
  body      String
  entityId  String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, entityId])
}

model FeaturedListingPurchase {
  id                String   @id @default(cuid())
  gymId             String
  ownerId           String
  amount            Int
  status            String   // PENDING | CAPTURED | FAILED
  razorpayOrderId   String
  razorpayPaymentId String?
  createdAt         DateTime @default(now())

  gym   Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@unique([razorpayOrderId])
}

model VerifiedBadgePurchase {
  id                String   @id @default(cuid())
  gymId             String
  ownerId           String
  amount            Int
  status            String   // PENDING | CAPTURED | FAILED
  razorpayOrderId   String
  razorpayPaymentId String?
  createdAt         DateTime @default(now())

  gym   Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@unique([razorpayOrderId])
}

model SavedGym {
  id        String   @id @default(cuid())
  userId    String
  gymId     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  gym  Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@unique([userId, gymId])
}

model DiscountCode {
  id             String   @id @default(cuid())
  gymId          String
  code           String
  discountType   String   @default("PERCENT") // PERCENT | FLAT
  discountValue  Int
  maxUses        Int      @default(100)
  usedCount      Int      @default(0)
  validFrom      DateTime @default(now())
  validUntil     DateTime
  createdAt      DateTime @default(now())

  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@unique([gymId, code])
}

model Membership {
  id           String   @id @default(cuid())
  userId       String
  gymId        String
  planType     String   // DAY_PASS | MONTHLY | QUARTERLY | YEARLY
  basePrice    Int      // in paise
  finalPrice   Int      // in paise
  discountBreakdown String? // JSON
  active       Boolean  @default(true)
  startedAt    DateTime @default(now())
  expiresAt    DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  gym  Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  invoice Invoice? @relation("MembershipInvoice")
}

model GymPageView {
  id        String   @id @default(cuid())
  gymId     String
  userId    String?
  createdAt DateTime @default(now())

  gym  Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([gymId, createdAt])
}

model Duo {
  id        String   @id @default(cuid())
  userOneId String
  userTwoId String
  gymId     String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  userOne User @relation("UserOne", fields: [userOneId], references: [id], onDelete: Cascade)
  userTwo User @relation("UserTwo", fields: [userTwoId], references: [id], onDelete: Cascade)
  gym     Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@unique([userOneId, userTwoId, gymId])
}

model Invite {
  id            String   @id @default(cuid())
  email         String
  code          String   @unique
  gymId         String
  inviterId     String
  invitedUserId String?  // set when invitee joins (for join-together flow)
  accepted      Boolean  @default(false)
  createdAt     DateTime @default(now())

  gym    Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  inviter User @relation("Inviter", fields: [inviterId], references: [id], onDelete: Cascade)
}


model Lead {
  id           String   @id @default(cuid())
  gymId        String
  userId       String?
  type         String   // BOOK_CTA | ENQUIRY
  message      String?
  contactName  String?
  contactEmail String?
  contactPhone String?
  createdAt    DateTime @default(now())

  gym  Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([gymId, createdAt])
  @@index([userId])
}

model PhoneOtp {
  id          String   @id @default(cuid())
  phoneNumber String   @unique
  codeHash    String
  expiresAt   DateTime
  sendCount   Int      @default(1)
  lastSentAt  DateTime @default(now())
  attempts    Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([phoneNumber])
  @@index([expiresAt])
}

model WhatsAppLog {
  id        String   @id @default(cuid())
  eventType String
  toNumber  String
  status    String   // SENT | FAILED | SKIPPED
  error     String?
  payload   Json?
  gymId     String?
  userId    String?
  createdAt DateTime @default(now())

  gym  Gym?  @relation(fields: [gymId], references: [id], onDelete: SetNull)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([eventType, createdAt])
  @@index([gymId])
  @@index([userId])
}

model SubscriptionReminderLog {
  id               String   @id @default(cuid())
  ownerId          String
  subscriptionId   String
  daysBeforeExpiry Int
  channel          String   // EMAIL | WHATSAPP
  status           String   // SENT | FAILED | SKIPPED
  error            String?
  createdAt        DateTime @default(now())

  owner        User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  subscription OwnerSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, daysBeforeExpiry, channel])
  @@index([ownerId])
}

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  ownerId       String
  gymId         String?
  userId        String?
  membershipId  String?  @unique
  transactionId String?
  invoiceType   InvoiceType @default(NON_GST)
  taxMode       InvoiceTaxMode @default(NONE)
  gstRate       Int?
  subtotal      Int
  taxTotal      Int
  total         Int
  amount        Int
  currency      String   @default("INR")
  gymName       String
  gymAddress    String?
  gymCity       String?
  gymState      String?
  gymGstNumber  String?
  memberName    String?
  memberEmail   String?
  memberState   String?
  pdfUrl        String?
  gstNumber     String?
  status        String   @default("ISSUED")
  issuedAt      DateTime @default(now())
  createdAt     DateTime @default(now())

  owner User @relation("OwnerInvoices", fields: [ownerId], references: [id], onDelete: Cascade)
  gym   Gym?  @relation(fields: [gymId], references: [id], onDelete: SetNull)
  user  User? @relation("MemberInvoices", fields: [userId], references: [id], onDelete: SetNull)
  membership Membership? @relation("MembershipInvoice", fields: [membershipId], references: [id], onDelete: SetNull)
  transaction Transaction? @relation("TransactionInvoice")
  items InvoiceItem[]
  taxes InvoiceTax[]

  @@index([ownerId, issuedAt])
  @@index([gymId])
  @@index([transactionId])
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int
  unitPrice   Int
  total       Int
  createdAt   DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model InvoiceTax {
  id        String   @id @default(cuid())
  invoiceId String
  taxType   InvoiceTaxType
  rate      Int
  amount    Int
  createdAt DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model InvoiceSequence {
  id         String   @id @default(cuid())
  gymId      String   @unique
  lastNumber Int      @default(0)
  updatedAt  DateTime @updatedAt

  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)
}

model Payment {
  id                 String   @id @default(cuid())
  userId             String
  gymId              String
  amount             Int      // in paise
  razorpayOrderId    String?
  razorpayPaymentId  String?
  status             String   // PENDING | CAPTURED | FAILED
  createdAt          DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  gym  Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
}

model Transaction {
  id                        String   @id @default(cuid())
  userId                    String
  gymId                     String
  membershipId              String
  invoiceId                 String?  @unique
  totalAmount               Int      // in paise
  platformCommissionAmount  Int      // in paise
  gymPayoutAmount           Int      // in paise
  razorpayOrderId           String   @unique
  razorpayPaymentId         String?
  paymentStatus             String   // CREATED | PAID | FAILED
  settlementStatus          String   // NOT_STARTED | PARTIAL | COMPLETED
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  gym        Gym        @relation(fields: [gymId], references: [id], onDelete: Cascade)
  membership Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  invoice    Invoice?   @relation("TransactionInvoice", fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([gymId])
  @@index([membershipId])
}

model RazorpayWebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique
  eventType   String
  payload     Json
  processedAt DateTime?
  createdAt   DateTime @default(now())
}
