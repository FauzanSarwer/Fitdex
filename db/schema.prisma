generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // hashed for credentials
  role          String    @default("USER") // USER | OWNER | ADMIN
  latitude      Float?
  longitude     Float?
  city          String?
  state         String?
  phoneNumber   String?
  billingEmail  String?
  timezone      String?
  notifyMemberships Boolean @default(true)
  notifyPromos  Boolean  @default(true)
  notifyDuo     Boolean  @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]
  memberships Membership[]
  duosAsOne    Duo[]       @relation("UserOne")
  duosAsTwo    Duo[]       @relation("UserTwo")
  invitesSent  Invite[]    @relation("Inviter")
  payments     Payment[]
  transactions Transaction[]
  ownedGyms    Gym[]
  savedGyms    SavedGym[]
  featuredPurchases FeaturedListingPurchase[]
  verifiedPurchases VerifiedBadgePurchase[]
  notifications Notification[]
  passwordResetTokens PasswordResetToken[]
  gymPageViews GymPageView[]
  emailVerificationTokens EmailVerificationToken[]
  ownerSubscriptions OwnerSubscription[]
}

model OwnerSubscription {
  id                 String   @id @default(cuid())
  ownerId            String
  plan               String   // STARTER | PRO
  status             String   // PENDING | ACTIVE | CANCELED | EXPIRED
  startsAt           DateTime
  expiresAt          DateTime
  razorpayOrderId    String?  @unique
  razorpayPaymentId  String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId])
  @@index([status])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  purpose   String   // VERIFY | DELETE
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Gym {
  id                     String   @id @default(cuid())
  name                   String
  address                String
  latitude               Float
  longitude              Float
  ownerId                String
  verificationStatus     String   @default("UNVERIFIED") // UNVERIFIED | PENDING | VERIFIED | REJECTED
  verificationNotes      String?
  gstNumber              String?
  gstCertificateUrl      String?
  gstVerifiedAt          DateTime?
  razorpaySubAccountId   String?
  bankAccountLast4       String?
  bankAccountVerified    Boolean  @default(false)
  openTime               String?  // "HH:mm"
  closeTime              String?  // "HH:mm"
  openDays               String?  // "MON,TUE,WED,THU,FRI,SAT,SUN"
  dayPassPrice           Int?     // in paise, optional
  monthlyPrice           Int      // in paise
  quarterlyPrice         Int?     // in paise, null = computed as monthlyPrice * 3
  yearlyPrice            Int      // in paise
  partnerDiscountPercent Int      @default(10)
  quarterlyDiscountType  String   @default("PERCENT") // PERCENT | FLAT
  quarterlyDiscountValue Int      @default(10)        // percent or paise (if FLAT)
  yearlyDiscountType     String   @default("PERCENT") // PERCENT | FLAT
  yearlyDiscountValue    Int      @default(15)        // percent or paise (if FLAT)
  welcomeDiscountType    String   @default("PERCENT") // PERCENT | FLAT
  welcomeDiscountValue   Int      @default(10)        // percent or paise (if FLAT)
  coverImageUrl          String?  // optional gym photo
  instagramUrl           String?
  facebookUrl            String?
  youtubeUrl             String?
  featuredUntil          DateTime?
  verifiedUntil          DateTime?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  owner        User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  memberships  Membership[]
  duos         Duo[]
  invites      Invite[]
  payments     Payment[]
  discountCodes DiscountCode[]
  savedBy      SavedGym[]
  featuredPurchases FeaturedListingPurchase[]
  verifiedPurchases VerifiedBadgePurchase[]
  transactions Transaction[]
  pageViews   GymPageView[]
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // membership_expiring | duo_accepted
  title     String
  body      String
  entityId  String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, entityId])
}

model FeaturedListingPurchase {
  id                String   @id @default(cuid())
  gymId             String
  ownerId           String
  amount            Int
  status            String   // PENDING | CAPTURED | FAILED
  razorpayOrderId   String
  razorpayPaymentId String?
  createdAt         DateTime @default(now())

  gym   Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@unique([razorpayOrderId])
}

model VerifiedBadgePurchase {
  id                String   @id @default(cuid())
  gymId             String
  ownerId           String
  amount            Int
  status            String   // PENDING | CAPTURED | FAILED
  razorpayOrderId   String
  razorpayPaymentId String?
  createdAt         DateTime @default(now())

  gym   Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@unique([razorpayOrderId])
}

model SavedGym {
  id        String   @id @default(cuid())
  userId    String
  gymId     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  gym  Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@unique([userId, gymId])
}

model DiscountCode {
  id             String   @id @default(cuid())
  gymId          String
  code           String
  discountType   String   @default("PERCENT") // PERCENT | FLAT
  discountValue  Int
  maxUses        Int      @default(100)
  usedCount      Int      @default(0)
  validFrom      DateTime @default(now())
  validUntil     DateTime
  createdAt      DateTime @default(now())

  gym Gym @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@unique([gymId, code])
}

model Membership {
  id           String   @id @default(cuid())
  userId       String
  gymId        String
  planType     String   // DAY_PASS | MONTHLY | QUARTERLY | YEARLY
  basePrice    Int      // in paise
  finalPrice   Int      // in paise
  discountBreakdown String? // JSON
  active       Boolean  @default(true)
  startedAt    DateTime @default(now())
  expiresAt    DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  gym  Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  transactions Transaction[]
}

model GymPageView {
  id        String   @id @default(cuid())
  gymId     String
  userId    String?
  createdAt DateTime @default(now())

  gym  Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([gymId, createdAt])
}

model Duo {
  id        String   @id @default(cuid())
  userOneId String
  userTwoId String
  gymId     String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  userOne User @relation("UserOne", fields: [userOneId], references: [id], onDelete: Cascade)
  userTwo User @relation("UserTwo", fields: [userTwoId], references: [id], onDelete: Cascade)
  gym     Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)

  @@unique([userOneId, userTwoId, gymId])
}

model Invite {
  id            String   @id @default(cuid())
  email         String
  code          String   @unique
  gymId         String
  inviterId     String
  invitedUserId String?  // set when invitee joins (for join-together flow)
  accepted      Boolean  @default(false)
  createdAt     DateTime @default(now())

  gym    Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
  inviter User @relation("Inviter", fields: [inviterId], references: [id], onDelete: Cascade)
}

model Payment {
  id                 String   @id @default(cuid())
  userId             String
  gymId              String
  amount             Int      // in paise
  razorpayOrderId    String?
  razorpayPaymentId  String?
  status             String   // PENDING | CAPTURED | FAILED
  createdAt          DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  gym  Gym  @relation(fields: [gymId], references: [id], onDelete: Cascade)
}

model Transaction {
  id                        String   @id @default(cuid())
  userId                    String
  gymId                     String
  membershipId              String
  totalAmount               Int      // in paise
  platformCommissionAmount  Int      // in paise
  gymPayoutAmount           Int      // in paise
  razorpayOrderId           String   @unique
  razorpayPaymentId         String?
  paymentStatus             String   // CREATED | PAID | FAILED
  settlementStatus          String   // NOT_STARTED | PARTIAL | COMPLETED
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  gym        Gym        @relation(fields: [gymId], references: [id], onDelete: Cascade)
  membership Membership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([gymId])
  @@index([membershipId])
}

model RazorpayWebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique
  eventType   String
  payload     Json
  processedAt DateTime?
  createdAt   DateTime @default(now())
}
